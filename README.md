# 音叉の物理情報ニューラルネットワーク (PINN)

[![Rust](https://img.shields.io/badge/rust-1.78.0+-orange.svg)](https://www.rust-lang.org/)
[![Burn](https://img.shields.io/badge/burn-0.17.1-blue.svg)](https://burn.dev/)

このプロジェクトは、Rustのディープラーニングフレームワーク [Burn](https://burn.dev/) を使用して**物理情報ニューラルネットワーク (Physics-Informed Neural Network, PINN)** を実装するデモンストレーションです。

従来の教師あり学習のように「正解データ」を与える代わりに、物理法則そのものを損失関数に組み込むことで、指定された周波数（例: 440Hz）を生成する音叉の物理的な寸法をニューラルネットワークに推論させます。

---

## 🚀 使い方

### 1. 前提条件

* [Rust](https://www.rust-lang.org/tools/install) （1.78.0以降を推奨）

### 2. インストール

リポジトリをクローンして、プロジェクトディレクトリに移動します。

```bash
git clone <repository_url>
cd burn-tuningfork-pinn
```

### 3. モデルの学習

以下のコマンドでモデルの学習を開始します。学習には数分かかります。成果物は `./artifacts` ディレクトリに保存されます。

**GPU (wgpu) を使用する場合 (デフォルト):**

```bash
cargo run --release -- --backend wgpu train
```

**GPU (CUDA) を使用する場合:**

```bash
cargo run --release -- --backend cuda train
```

**CPU (ndarray) を使用する場合:**

```bash
cargo run --release -- --backend ndarray train
```

* `--backend`: 使用する計算バックエンドを指定します (`wgpu`, `cuda`, `ndarray`)。
* `train`: 学習モードを実行するサブコマンドです。

### 4. 推論の実行

学習が完了すると、保存されたモデル (`./artifacts/model.mpk`) を使って推論を実行できます。

例えば、**440Hz**の音叉の寸法を予測するには、以下のコマンドを実行します。

```bash
cargo run --release -- --backend wgpu infer --freq 440
```

* `infer`: 推論モードを実行するサブコマンドです。
* `--freq <number>`: 予測したい周波数(Hz)を指定します。

**実行結果の例:**

```
🔍 Inferring for frequency: 440 Hz on WgpuDevice { .. }...

--- Predicted Dimensions (in meters) ---
  - Handle Length:     0.075123
  - Handle Diameter:   0.008123
  - Prong Length:      0.069456
  - Prong Diameter:    0.004789
  - Prong Gap:         0.005123
----------------------------------------
```

---

## ⚙️ 技術的なコンセプト

### 物理情報ニューラルネットワーク (PINN)

このプロジェクトの核心は、データではなく**物理法則**に基づいてモデルを訓練することです。

1.  **入力**: モデルは「周波数」($f$) という1次元のデータのみを受け取ります。
2.  **予測**: モデルは音叉の5つの物理的な寸法（柄の長さ、プロングの直径など）を予測します。
3.  **物理計算**: 予測された寸法を使い、物理公式に基づいて周波数を**逆算**します。
4.  **損失計算**: 逆算された周波数と、最初に入力した目標周波数との誤差を計算します。この誤差がモデルの「損失」となります。
5.  **最適化**: モデルは、この損失が最小になるように（=物理法則に最も適合するように）自身のパラメータを更新します。

### 物理モデル

音叉の基本周波数を計算するために、以下の数式（ティモシェンコ梁理論の簡略版）を使用します。

$
f_{predicted} = \frac{K}{L_p^2} \sqrt{\frac{E \cdot I}{ho \cdot A}}
$

-   $f_{predicted}$: 予測される周波数 (Hz)
-   $L_p$: プロング（腕）の長さ (m)
-   $E$: 材料のヤング率 (Pa)
-   $I$: プロング断面の断面二次モーメント ($m^4$)
-   $ho$: 材料の密度 (kg/m³)
-   $A$: プロングの断面積 (m²)
-   $K$: 形状や振動モードで決まる係数（定数）

各変数は、モデルが予測した寸法から以下のように計算されます。

-   断面積 $A = \frac{\pi D_p^2}{4}$
-   断面二次モーメント $I = \frac{\pi D_p^4}{64}$
-   $D_p$: プロングの直径 (m)

### 損失関数

損失は、単なる周波数の誤差だけではありません。物理的にありえない形状が生成されるのを防ぐため、以下のペナルティ項が追加されています。

*   **周波数損失**: $(f_{predicted} - f_{target})^2$
*   **物理的制約ペナルティ**:
    *   `ratio_penalty`: 「プロング（腕）の長さは、柄の長さを超えてはならない」という制約。
    *   `range_penalty`: 「プロングの直径は、物理的に妥当な範囲 (例: 0.002m ~ 0.02m) に収まるべき」という制約。

これらの損失とペナルティを合計したものが、最終的な損失関数となります。

---

## 📂 プロジェクト構造

```
.
├── Cargo.toml      # プロジェクトと依存関係の定義
├── artifacts/      # 学習済みモデルやログの保存先
├── src/
│   ├── main.rs     # コマンドライン引数の解析と処理の開始
│   ├── lib.rs      # ライブラリのルートとモジュールの公開
│   ├── model.rs    # ニューラルネットワークモデルのアーキテクチャ定義
│   ├── train.rs    # 学習ループ、データローダー、学習ステップの実装
│   ├── infer.rs    # 学習済みモデルを読み込み推論を実行するロジック
│   ├── physics.rs  # 物理法則に基づいたカスタム損失関数の実装
│   └── constants.rs  # 物理定数やモデルの定数の定義
└── README.md       # このファイル
```
